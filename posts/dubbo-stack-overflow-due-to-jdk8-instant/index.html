<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>JDK8日期时间API导致Dubbo调用StackOverflow错误 - dingyufan's blog</title><meta name=author content>
<meta name=description content="this is dingyufan's blog"><meta name=keywords content='Dubbo,Java'><meta itemprop=name content="JDK8日期时间API导致Dubbo调用StackOverflow错误"><meta itemprop=description content="this is dingyufan's blog"><meta itemprop=datePublished content="2022-04-30T11:34:02+08:00"><meta itemprop=dateModified content="2023-07-28T16:32:25+08:00"><meta itemprop=wordCount content="10159"><meta itemprop=keywords content="Dubbo,Java"><meta property="og:url" content="https://dingyufan.github.io/posts/dubbo-stack-overflow-due-to-jdk8-instant/"><meta property="og:site_name" content="dingyufan's blog"><meta property="og:title" content="JDK8日期时间API导致Dubbo调用StackOverflow错误"><meta property="og:description" content="this is dingyufan's blog"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-30T11:34:02+08:00"><meta property="article:modified_time" content="2023-07-28T16:32:25+08:00"><meta property="article:tag" content="Dubbo"><meta property="article:tag" content="Java"><meta name=twitter:card content="summary"><meta name=twitter:title content="JDK8日期时间API导致Dubbo调用StackOverflow错误"><meta name=twitter:description content="this is dingyufan's blog"><meta name=application-name content="dingyufan's blog"><meta name=apple-mobile-web-app-title content="dingyufan's blog"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://dingyufan.github.io/posts/dubbo-stack-overflow-due-to-jdk8-instant/ title="JDK8日期时间API导致Dubbo调用StackOverflow错误 - dingyufan's blog"><link rel=prev type=text/html href=https://dingyufan.github.io/posts/githubpages-hugo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/ title="GitHub Pages + Hugo搭建个人博客"><link rel=next type=text/html href=https://dingyufan.github.io/posts/%E6%B5%85%E5%B0%9D%E6%A0%91%E8%8E%93%E6%B4%BE4bubuntu22.04%E5%AE%89%E8%A3%85clash%E4%BD%9C%E4%B8%BA%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/ title=浅尝树莓派4B(Ubuntu22.04)安装Clash作为代理服务器><link rel=alternate type=text/markdown href=https://dingyufan.github.io/posts/dubbo-stack-overflow-due-to-jdk8-instant/index.md title="JDK8日期时间API导致Dubbo调用StackOverflow错误 - dingyufan's blog"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"JDK8日期时间API导致Dubbo调用StackOverflow错误","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/dingyufan.github.io\/posts\/dubbo-stack-overflow-due-to-jdk8-instant\/"},"genre":"posts","keywords":"Dubbo, Java","wordcount":10159,"url":"https:\/\/dingyufan.github.io\/posts\/dubbo-stack-overflow-due-to-jdk8-instant\/","datePublished":"2022-04-30T11:34:02+08:00","dateModified":"2023-07-28T16:32:25+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"作者"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="dingyufan's blog"><span class=header-title-text>dingyufan's blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="dingyufan's blog"><span class=header-title-text>dingyufan's blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>JDK8日期时间API导致Dubbo调用StackOverflow错误</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
Anonymous</span></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/coding/ class=post-category title="分类 - Coding"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Coding</a></span></div><div class=post-meta-line><span title="发布于 2022-04-30 11:34:02"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2022-04-30>2022-04-30</time></span>&nbsp;<span title="更新于 2023-07-28 16:32:25"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2023-07-28>2023-07-28</time></span>&nbsp;<span title="10159 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 10200 字</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#0-前言>0 前言</a></li><li><a href=#1-问题>1 问题</a></li><li><a href=#3-dubbo序列化response>3 Dubbo序列化Response</a><ul><li><a href=#31-exchangecodec--dubbocodec>3.1 ExchangeCodec / DubboCodec</a><ul><li><a href=#311-获取序列化方式>3.1.1 获取序列化方式</a></li><li><a href=#312-得到序列化器>3.1.2 得到序列化器</a></li><li><a href=#313-对调用结果进行序列化>3.1.3 对调用结果进行序列化</a></li></ul></li><li><a href=#32-hessian2objectoutput>3.2 Hessian2ObjectOutput</a></li><li><a href=#33-hessian2output>3.3 Hessian2Output</a></li><li><a href=#34-serializerfactory--hessian2serializerfactory>3.4 SerializerFactory / Hessian2SerializerFactory</a></li><li><a href=#35-javaserializer>3.5 JavaSerializer</a><ul><li><a href=#351-writereplace方法>3.5.1 writeReplace方法</a></li><li><a href=#352-fieldserializer>3.5.2 FieldSerializer</a></li></ul></li><li><a href=#36-序列化调用栈>3.6 序列化调用栈</a></li></ul></li><li><a href=#4-结论>4 结论</a></li><li><a href=#5-解决方案>5 解决方案</a><ul><li><a href=#51-使用date类型>5.1 使用Date类型</a></li><li><a href=#51-writereplace--readresolve-方法>5.1 writeReplace / readResolve 方法</a></li><li><a href=#52-修改序列化方式>5.2 修改序列化方式</a></li><li><a href=#53-升级dubbo版本>5.3 升级Dubbo版本（√）</a><ul><li><a href=#26x-支持jdk8时间api>2.6.x 支持JDK8时间API</a></li><li><a href=#26x-支持扩展serializerfactory>2.6.x 支持扩展SerializerFactory</a></li></ul></li><li><a href=#54-spi扩展serialization>5.4 SPI扩展Serialization</a></li></ul></li><li><a href=#6-写在最后>6 写在最后</a></li></ul></nav></div></div><div class=content id=content><h2 id=0-前言 class=heading-element><span>0 前言</span>
<a href=#0-%e5%89%8d%e8%a8%80 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>博客搭建之后，不知道从何写起。思来想去，决定从记录一些工作中遇到的问题开始。一来对问题有个归档，算是有一些积累，方便日后回顾；二来促使自己遇到问题时能探本朔源，做到知其然知其所以然，不要草草百度了事。不积跬步，无以至千里；不积小流，无以成江海。</p><h2 id=1-问题 class=heading-element><span>1 问题</span>
<a href=#1-%e9%97%ae%e9%a2%98 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>最近项目中使用dubbo（<strong>v2.5.3</strong>）的时候，遇到一个问题：dubbo服务方在对response编码时失败，发生了栈溢出异常。可以通过一个demo(<a href=https://github.com/dingyufan/blog-demo-all/tree/main/dubbo-stack-overflow-due-to-jkd8-instant target=_blank rel="external nofollow noopener noreferrer">dubbo-stack-overflow-due-to-jkd8-instant</a>)复现这个异常。</p><p><img loading=lazy src=https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220421171300795.png alt=image-20220421171300795 srcset="https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220421171300795.png?size=small, https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220421171300795.png?size=medium 1.5x, https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220421171300795.png?size=large 2x" data-title=image-20220421171300795 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></p><p>看到栈溢出，一般想到的情况要么是递归过深，或是循环调用方法次数过多。为什么会在dubbo序列化编码的时候发生这个异常呢？通过查看源码提交记录，结合异常信息Fail to encode repsonse，并且在异常栈中出现JavaSerializer类，判断<strong>问题出在Dubbo在对Response序列化时无法处理Instant类型对象</strong>。</p><p>网上搜索到的博客基本上只是说了有这样的问题，但是没有说明具体的原因，都是草草改用Date了事。通过这篇博客，记录一下Instant类型对象引起Dubbo对Response序列化失败导致栈溢出的根本原因以及解决方案。</p><h2 id=3-dubbo序列化response class=heading-element><span>3 Dubbo序列化Response</span>
<a href=#3-dubbo%e5%ba%8f%e5%88%97%e5%8c%96response class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>dubbo对不同协议、不同序列化方式处理方式是不一样的。此项目使用默认协议：<strong>dubbo协议</strong>，同时也采用dubbo协议默认序列化方式**：hessian2**。下文的序列化过程分析就是基于此的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- dubbo协议hessian2序列化方式，是dubbo的默认值。所以在xml配置中写不写这行配置都可以 --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dubbo:protocol</span> <span class=na>name=</span><span class=s>&#34;dubbo&#34;</span> <span class=na>serialization=</span><span class=s>&#34;hessian2&#34;</span><span class=nt>/&gt;</span></span></span></code></pre></td></tr></table></div></div><p>**参考官网文档 <a href=https://dubbo.apache.org/zh/docs/v2.7/dev/source/service-invoking-process/#24-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E6%96%B9%E8%BF%94%E5%9B%9E%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%9C target=_blank rel="external nofollow noopener noreferrer">2.4 服务提供方返回调用结果</a> **，我们从Dubbo处理返回结果入手。</p><h3 id=31-exchangecodec--dubbocodec class=heading-element><span>3.1 ExchangeCodec / DubboCodec</span>
<a href=#31-exchangecodec--dubbocodec class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>ExchangeCodec是Dubbo <strong>exchange信息交换层</strong>的编码器。<code>ExchangeCodec#encode(Channel, ChannelBuffer, Object)</code>方法是Dubbo对Request和Response进行编码的入口，逻辑很简单，主要是根据消息的类型，交由对应方法进行编码，对于不是自己负责的非Request、Response类型的消息对象，交给父类处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ExchangeCodec.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>encode</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>ChannelBuffer</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>encodeRequest</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>Request</span><span class=p>)</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 对response对象进行编码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>encodeResponse</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>Response</span><span class=p>)</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>ExchangeCodec#encodeResponse(Channel, ChannelBuffer, Response)</code>方法主要做的就是组装消息写入ChannelBuffer，这样消息就可以发送给调用方。消息两部分组成：<strong>消息头</strong>，包含状态序列化等相关信息的字节数组；<strong>消息体</strong>：Response返回的具体数据转换成的字节数组。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ExchangeCodec.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>encodeResponse</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>ChannelBuffer</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>Response</span><span class=w> </span><span class=n>res</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取序列化方式*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Serialization</span><span class=w> </span><span class=n>serialization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getSerialization</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 消息头字节数组。长度16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>header</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>HEADER_LENGTH</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 消息头 写入魔数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bytes</span><span class=p>.</span><span class=na>short2bytes</span><span class=p>(</span><span class=n>MAGIC</span><span class=p>,</span><span class=w> </span><span class=n>header</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 消息头 写入序列化器ID信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>header</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serialization</span><span class=p>.</span><span class=na>getContentTypeId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>isHeartbeat</span><span class=p>())</span><span class=w> </span><span class=n>header</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>FLAG_EVENT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>res</span><span class=p>.</span><span class=na>getStatus</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 消息头 写入状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>header</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 消息头 写入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bytes</span><span class=p>.</span><span class=na>long2bytes</span><span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>header</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>savedWriteIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>(</span><span class=n>savedWriteIndex</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>HEADER_LENGTH</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChannelBufferOutputStream</span><span class=w> </span><span class=n>bos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ChannelBufferOutputStream</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 得到序列化器*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutput</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serialization</span><span class=p>.</span><span class=na>serialize</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span><span class=w> </span><span class=n>bos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Response</span><span class=p>.</span><span class=na>OK</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>isHeartbeat</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>encodeHeartbeatData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>res</span><span class=p>.</span><span class=na>getResult</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 对调用结果进行序列化*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 这个方法会调用子类DubboCodec的override方法实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>encodeResponseData</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>res</span><span class=p>.</span><span class=na>getResult</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=n>out</span><span class=p>.</span><span class=na>writeUTF</span><span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=na>getErrorMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>out</span><span class=p>.</span><span class=na>flushBuffer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>bos</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>bos</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 消息体字节长度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bos</span><span class=p>.</span><span class=na>writtenBytes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkPayload</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bytes</span><span class=p>.</span><span class=na>int2bytes</span><span class=p>(</span><span class=n>len</span><span class=p>,</span><span class=w> </span><span class=n>header</span><span class=p>,</span><span class=w> </span><span class=n>12</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 先写完消息体，再写消息头，再设置writeIndex位置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>(</span><span class=n>savedWriteIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>buffer</span><span class=p>.</span><span class=na>writeBytes</span><span class=p>(</span><span class=n>header</span><span class=p>);</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>(</span><span class=n>savedWriteIndex</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>HEADER_LENGTH</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在这里先不关注消息头、ChannelBuffer等操作，这次主要看序列化相关的几个步骤：</p><h4 id=311-获取序列化方式 class=heading-element><span>3.1.1 获取序列化方式</span>
<a href=#311-%e8%8e%b7%e5%8f%96%e5%ba%8f%e5%88%97%e5%8c%96%e6%96%b9%e5%bc%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>这里实际是父类中的方法<code>AbstractCodec#getSerialization(Channel)</code>方法。这一步是利用Dubbo SPI机制，实例化一个序列化方式对象。具体过程不是本次的重点，只要理解这一步会根据<code>&lt;dubbo:protocol></code>配置的序列化方式返回对应的序列化方式对象。比如这里得到的就是Hessian2Serialization对象。</p><h4 id=312-得到序列化器 class=heading-element><span>3.1.2 得到序列化器</span>
<a href=#312-%e5%be%97%e5%88%b0%e5%ba%8f%e5%88%97%e5%8c%96%e5%99%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>这里调用<code>Serialization#serialize(URL, OutputStream)</code>方法，得到一个序列化器。hessian2序列化提供的序列化器是Hessian2ObjectOutput对象，通过构造函数传入了<code>ExchangeCodec#encodeResponse(Channel, ChannelBuffer, Response)</code>方法中定义的包装了buffer的bos。这样Hessian2ObjectOutput对象可以将具体数据写入到buffer中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Hessian2Serialization</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serialization</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>byte</span><span class=w> </span><span class=n>ID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>byte</span><span class=w> </span><span class=nf>getContentTypeId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ID</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getContentType</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;x-application/hessian2&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ObjectOutput</span><span class=w> </span><span class=nf>serialize</span><span class=p>(</span><span class=n>URL</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>OutputStream</span><span class=w> </span><span class=n>out</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 序列化器对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hessian2ObjectOutput</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ObjectInput</span><span class=w> </span><span class=nf>deserialize</span><span class=p>(</span><span class=n>URL</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>InputStream</span><span class=w> </span><span class=n>is</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hessian2ObjectInput</span><span class=p>(</span><span class=n>is</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 id=313-对调用结果进行序列化 class=heading-element><span>3.1.3 对调用结果进行序列化</span>
<a href=#313-%e5%af%b9%e8%b0%83%e7%94%a8%e7%bb%93%e6%9e%9c%e8%bf%9b%e8%a1%8c%e5%ba%8f%e5%88%97%e5%8c%96 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>配置中指定的是dubbo协议，这里实际会被调用的是<code>DubboCodec#encodeResponseData(Channel, ObjectOutput, Object)</code>重写方法。DubboCodec继承自ExchangeCodec，是Dubbo <strong>protocol远程调用层</strong>的编码器，主要负责实现协议层面的Response数据编码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// DubboCodec.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>encodeResponseData</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>ObjectOutput</span><span class=w> </span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Result</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Result</span><span class=p>)</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Throwable</span><span class=w> </span><span class=n>th</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>getException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>th</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>writeByte</span><span class=p>(</span><span class=n>RESPONSE_NULL_VALUE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 序列化器中写入response数据标志位</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>writeByte</span><span class=p>(</span><span class=n>RESPONSE_VALUE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 序列化器中写入正常返回的对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>ret</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>out</span><span class=p>.</span><span class=na>writeByte</span><span class=p>(</span><span class=n>RESPONSE_WITH_EXCEPTION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>out</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>th</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=32-hessian2objectoutput class=heading-element><span>3.2 Hessian2ObjectOutput</span>
<a href=#32-hessian2objectoutput class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>在3.1.2中提到过，得到的序列化器是Hessian2ObjectOutput，实现了ObjectOutput接口。对于常见的简单数据对象，ObjectOutput接口中都定义了相应处理方法，同时还定义writeObject(Object)方法处理复杂对象的序列化。</p><p>Hessian2ObjectOutput实现了接口定义的各个方法，通过一个Hessian2Output对象，完成各种数据类型hessian2序列化的具体操作。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Hessian2ObjectOutput</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ObjectOutput</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Hessian2Output</span><span class=w> </span><span class=n>mH2o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=nf>Hessian2ObjectOutput</span><span class=p>(</span><span class=n>OutputStream</span><span class=w> </span><span class=n>os</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>mH2o</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hessian2Output</span><span class=p>(</span><span class=n>os</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>mH2o</span><span class=p>.</span><span class=na>setSerializerFactory</span><span class=p>(</span><span class=n>Hessian2SerializerFactory</span><span class=p>.</span><span class=na>SERIALIZER_FACTORY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>writeBool</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>mH2o</span><span class=p>.</span><span class=na>writeBoolean</span><span class=p>(</span><span class=n>v</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>writeObject</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>mH2o</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>flushBuffer</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>mH2o</span><span class=p>.</span><span class=na>flushBuffer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><strong><code>Hessian2ObjectOutput#writeObject(Object)</code>方法是response数据对象序列化的入口</strong>，数据对象序列化的操作从这一步正式开始。这个方法中调用的是<code>Hessian2Output#writeObject(Object)</code>方法。</p><h3 id=33-hessian2output class=heading-element><span>3.3 Hessian2Output</span>
<a href=#33-hessian2output class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>注意Hessian2Output的方法，如<code>writeBoolean(boolean)</code>，对值进行编码写入的时候，没有直接写入<code> _os</code>，而是维护一个字节数组 <code>_buffer</code>和 <code>_offset</code>值。回头看3.1中的<code>ExchangeCodec#encodeResponse(Channel, ChannelBuffer, Response)</code>方法，会调用<code>out.flushBuffer()</code>，通过Hessian2ObjectOutput来调用<code>Hessian2Output#flushBuffer()</code>方法，将 <code>_buffer</code>内容写入 <code>_os</code> ，即写入 <code>bos</code>，即ChannelBuffer对象<code>buffer</code>。</p><p><code>Hessian2Output#writeObject(Object)</code>方法不像其他方法，没有直接向<code>_buffer</code>写入具体的字节，而是尝试获取一个Serializer对象，完成对象的序列化。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Hessian2Output</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractHessianOutput</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Hessian2Constants</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>protected</span><span class=w> </span><span class=n>OutputStream</span><span class=w> </span><span class=n>_os</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>byte</span><span class=w> </span><span class=o>[]</span><span class=n>_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>SIZE</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Hessian2Output</span><span class=p>(</span><span class=n>OutputStream</span><span class=w> </span><span class=n>os</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>_os</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>os</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>writeBoolean</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>SIZE</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_offset</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>16</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 不直接写入_os</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_buffer</span><span class=o>[</span><span class=n>_offset</span><span class=o>++]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>byte</span><span class=p>)</span><span class=w> </span><span class=sc>&#39;T&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_buffer</span><span class=o>[</span><span class=n>_offset</span><span class=o>++]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>byte</span><span class=p>)</span><span class=w> </span><span class=sc>&#39;F&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>writeObject</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>object</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>object</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>writeNull</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Serializer</span><span class=w> </span><span class=n>serializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获得序列化工厂类，获得一个Serializer对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findSerializerFactory</span><span class=p>().</span><span class=na>getSerializer</span><span class=p>(</span><span class=n>object</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 完成对象的序列化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>object</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>flushBuffer</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_offset</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=w> </span><span class=n>_isStreaming</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_os</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>_buffer</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_isStreaming</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_buffer</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sc>&#39;p&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_buffer</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>byte</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>8</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_buffer</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>byte</span><span class=p>)</span><span class=w> </span><span class=n>len</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_os</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>_buffer</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>findSerializerFactory()会从父类获得一个SerializerFactory对象，回头从3.2看到，在Hessian2ObjectOutput中，为Hessian2Output指定SerializerFactory 具体对象为<code>Hessian2SerializerFactory.SERIALIZER_FACTORY</code>。我们主要来看getSerializer(object.getClass())</p><h3 id=34-serializerfactory--hessian2serializerfactory class=heading-element><span>3.4 SerializerFactory / Hessian2SerializerFactory</span>
<a href=#34-serializerfactory--hessian2serializerfactory class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Hessian2SerializerFactory相对比较简单，只是实现了getClassLoader() 方法，然后在公共静态常量量中构造了一个Hessian2SerializerFactory对象供使用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Hessian2SerializerFactory</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>SerializerFactory</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>SerializerFactory</span><span class=w> </span><span class=n>SERIALIZER_FACTORY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hessian2SerializerFactory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=nf>Hessian2SerializerFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=n>ClassLoader</span><span class=w> </span><span class=nf>getClassLoader</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getContextClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>他父类SerializerFactory功能更加丰富。<code>SerializerFactory#getSerializer(Class)</code>方法比较长，但是其实整体逻辑并不复杂：<strong>根据类型Class返回相应的Serializer实例，如果类型和方法中列举的都不匹配，则会返回一个默认的Serializer对象，即 JavaSerializer对象</strong>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SerializerFactory</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractSerializerFactory</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Serializer</span><span class=w> </span><span class=nf>getSerializer</span><span class=p>(</span><span class=n>Class</span><span class=w> </span><span class=n>cl</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>HessianProtocolException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Serializer</span><span class=w> </span><span class=n>serializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Serializer</span><span class=p>)</span><span class=w> </span><span class=n>_staticSerializerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serializer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>serializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_cachedSerializerMap</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>_cachedSerializerMap</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Serializer</span><span class=p>)</span><span class=w> </span><span class=n>_cachedSerializerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serializer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>serializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>serializer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>_factories</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_factories</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AbstractSerializerFactory</span><span class=w> </span><span class=n>factory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AbstractSerializerFactory</span><span class=p>)</span><span class=w> </span><span class=n>_factories</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>.</span><span class=na>getSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serializer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>JavaSerializer</span><span class=p>.</span><span class=na>getWriteReplace</span><span class=p>(</span><span class=n>cl</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JavaSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>_loader</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>HessianRemoteObject</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RemoteSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//      else if (BurlapRemoteObject.class.isAssignableFrom(cl))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        serializer = new RemoteSerializer();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_mapSerializer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_mapSerializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MapSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_mapSerializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Collection</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_collectionSerializer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_collectionSerializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CollectionSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_collectionSerializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cl</span><span class=p>.</span><span class=na>isArray</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArraySerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThrowableSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>getClassLoader</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InputStreamSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Iterator</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IteratorSerializer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Enumeration</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EnumerationSerializer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Calendar</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CalendarSerializer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Locale</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LocaleSerializer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Enum</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EnumSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serializer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 都不符合以上类似，则返回默认的serializer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getDefaultSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_cachedSerializerMap</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_cachedSerializerMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>(</span><span class=n>8</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>_cachedSerializerMap</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 缓存这个类型对应的serializer，下次直接从缓存获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_cachedSerializerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>serializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>serializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Serializer</span><span class=w> </span><span class=nf>getDefaultSerializer</span><span class=p>(</span><span class=n>Class</span><span class=w> </span><span class=n>cl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_defaultSerializer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>_defaultSerializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>Serializable</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=w> </span><span class=n>_isAllowNonSerializable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Serialized class &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>cl</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; must implement java.io.Serializable&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JavaSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>_loader</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>对于demo中的返回的数据对象DemoDTO，很显然就是会得到一个JavaSerializer，通过它的完成序列化。</p><h3 id=35-javaserializer class=heading-element><span>3.5 JavaSerializer</span>
<a href=#35-javaserializer class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>回顾上文3.3节中，serializer对象完成序列哈的入库也是writeObject()方法。来看<code>JavaSerializer#writeObject(Object, AbstractHessianOutput)</code>方法。这里面序列化分两种情况：一是要序列化的对象有writeReplce()方法的，直接调用writeReplce()方法完成序列化；而是常规的使用静态类FieldSerializer序列化。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// JavaSerializer.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>writeObject</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>AbstractHessianOutput</span><span class=w> </span><span class=n>out</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>out</span><span class=p>.</span><span class=na>addRef</span><span class=p>(</span><span class=n>obj</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Class</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>obj</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用序列化对象的writeReplace方法完成序列化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_writeReplace</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>repl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_writeReplaceFactory</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>repl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_writeReplace</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>_writeReplaceFactory</span><span class=p>,</span><span class=w> </span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>repl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_writeReplace</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>removeRef</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>repl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>replaceRef</span><span class=p>(</span><span class=n>repl</span><span class=p>,</span><span class=w> </span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// log.log(Level.FINE, e.toString(), e);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// hessian2会写入对象开始标记;hessian会写map开始标记并返回-2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>out</span><span class=p>.</span><span class=na>writeObjectBegin</span><span class=p>(</span><span class=n>cl</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ref</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这种情况看起来是兼容hessian序列化的，而不是hessian2序列化的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// hessian序列化是把对象当做map处理，所以writeObject10()方法里会循环写入字段名称然后马上字段序列化，最后还会写一个map结束标志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>writeObject10</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ref</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 写入对象包含字段长度，以及各个类型字段信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>writeDefinition20</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 类型信息编码处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>writeObjectBegin</span><span class=p>(</span><span class=n>cl</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这里会开始会遍历序列化对象包含的各个字段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>writeInstance</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 id=351-writereplace方法 class=heading-element><span>3.5.1 writeReplace方法</span>
<a href=#351-writereplace%e6%96%b9%e6%b3%95 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>JavaSerializer 使用一个Method变量 <code>_writeReplace</code>保存writeReplace()方法，这个方法是从那里来的呢？在JavaSerializer构造方法中，会调用一个私有方法<code>introspectWriteReplace(Class, ClassLoader)</code>。它会从两个地方找writeReplace()方法：<strong>一是序列化类相应的HessianSerializer类；二是序列化类本身</strong>。但是要注意，HessianSerializer类的writeReplace方法签名 和 序列化类本身writeReplace方法签名 是有区别的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// JavaSerializer.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>introspectWriteReplace</span><span class=p>(</span><span class=n>Class</span><span class=w> </span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>loader</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>className</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cl</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;HessianSerializer&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 加载 序列化类类名+HessianSerializer的类。例如demo中的DemoDTO类，则会</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 尝试加载cn.dingyufan.blog.demo.dubbostackoverflowduetojkd8instantprovider.api.dto.DemoDTOHessianSerializer类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=w> </span><span class=n>serializerClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>className</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>loader</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 实例化相应的HessianSerializer类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>serializerObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serializerClass</span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 反射获取WriteReplace方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=w> </span><span class=n>writeReplace</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getWriteReplace</span><span class=p>(</span><span class=n>serializerClass</span><span class=p>,</span><span class=w> </span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>writeReplace</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_writeReplaceFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serializerObject</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_writeReplace</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>writeReplace</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 没有相应HessianSerializer类就会抛出ClassNotFoundException，这个异常不处理，后面会再次尝试从序列化类本身寻找</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>Level</span><span class=p>.</span><span class=na>FINER</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 从序列化类本身找writeReplace方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_writeReplace</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getWriteReplace</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 从要序列化的类型寻找 方法名为writeReplace、入参为空 的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=nf>getWriteReplace</span><span class=p>(</span><span class=n>Class</span><span class=w> </span><span class=n>cl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cl</span><span class=p>.</span><span class=na>getSuperclass</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=w> </span><span class=o>[]</span><span class=n>methods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cl</span><span class=p>.</span><span class=na>getDeclaredMethods</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>methods</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>methods</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;writeReplace&#34;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>method</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>().</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 从相应HessianSerializer类找到  方法名为writeReplace、 入参有且仅为要序列化类型  的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=nf>getWriteReplace</span><span class=p>(</span><span class=n>Class</span><span class=w> </span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=w> </span><span class=n>param</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cl</span><span class=p>.</span><span class=na>getSuperclass</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>cl</span><span class=p>.</span><span class=na>getDeclaredMethods</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;writeReplace&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>().</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>param</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>()</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>writeReplace方法提供了一种扩展序列化的方式，对与Dubbo暂不支持的类型，可以通过这个扩展点，返回一个自定义的类型的对象，替代原本需要序列化的对象，然后对自定义的对象进行序列化。</p><p>但是有个问题，<strong>如果producer通过writeReplace方法自定义一个对象来序列化，consumer反序列化时，怎么把自定义的对象转回原本类型呢？<strong>这里不展开讲，但是办法肯定是有的，答案就是</strong>readResolve方法</strong> 。: )</p><h4 id=352-fieldserializer class=heading-element><span>3.5.2 FieldSerializer</span>
<a href=#352-fieldserializer class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>对于没有writeReplace方法的类型，就继续走hessian2设定的序列化逻辑。从<code>JavaSerializer#writeInstance(Object, AbstractHessianOutput)</code>继续。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// JavaSerializer.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>writeInstance</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>AbstractHessianOutput</span><span class=w> </span><span class=n>out</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_fields</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_fields</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// _fieldSerializers是数组 FieldSerializer[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 是在JavaSerializer构造方法中，根据序列化类中各个字段类型，依次创建FieldSerializer(或子类)的实例存入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>_fieldSerializers</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>serialize</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>field</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// JavaSerializer构造方法中调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 根据序列化类中各个字段类型，返回对应类型的FieldSerializer(或子类)实例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>FieldSerializer</span><span class=w> </span><span class=nf>getFieldSerializer</span><span class=p>(</span><span class=n>Class</span><span class=w> </span><span class=n>type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>||</span><span class=w> </span><span class=kt>byte</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>||</span><span class=w> </span><span class=kt>short</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>||</span><span class=w> </span><span class=kt>int</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>IntFieldSerializer</span><span class=p>.</span><span class=na>SER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>LongFieldSerializer</span><span class=p>.</span><span class=na>SER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kt>double</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=kt>float</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>DoubleFieldSerializer</span><span class=p>.</span><span class=na>SER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kt>boolean</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>BooleanFieldSerializer</span><span class=p>.</span><span class=na>SER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>StringFieldSerializer</span><span class=p>.</span><span class=na>SER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Date</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=o>||</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>sql</span><span class=p>.</span><span class=na>Date</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=o>||</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>sql</span><span class=p>.</span><span class=na>Timestamp</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=o>||</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>sql</span><span class=p>.</span><span class=na>Time</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>type</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>DateFieldSerializer</span><span class=p>.</span><span class=na>SER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>FieldSerializer</span><span class=p>.</span><span class=na>SER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在<code>JavaSerializer#writeObject(Object, AbstractHessianOutput)</code>方法中，写完类型信息、类型字段长度、各字段名称后，就会通过writeInstance方法依次序列化类型中的各字段。字段的序列化，就是由静态类FieldSerializer类完成。</p><p>比如DemoDTO中的String类型字段，就会有FieldSerializer的子类StringFieldSerializer，完成<code>String consumer</code>字段序列化。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// JavaSerializer.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>StringFieldSerializer</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>FieldSerializer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>FieldSerializer</span><span class=w> </span><span class=n>SER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringFieldSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>serialize</span><span class=p>(</span><span class=n>AbstractHessianOutput</span><span class=w> </span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>field</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>Level</span><span class=p>.</span><span class=na>FINE</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用Hessian2Output类的writeString方法，值写入输出流</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>out</span><span class=p>.</span><span class=na>writeString</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>但是DemoDTO中的Instant类型字段，在<code>JavaSerializer#getFieldSerializer(Class)</code>方法中没有对应类型的，得到的是默认的FieldSerializer实例。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>FieldSerializer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>FieldSerializer</span><span class=w> </span><span class=n>SER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FieldSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>serialize</span><span class=p>(</span><span class=n>AbstractHessianOutput</span><span class=w> </span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>field</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>Level</span><span class=p>.</span><span class=na>FINE</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 又回到 Hessian2Output#writeObject(Object)方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 再次获得序列化工厂类Hessian2SerializerFactory，获得一个Serializer对象，又通过Serializer对象序列化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 这里有递归的感觉了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\n Java field: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>field</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOExceptionWrapper</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\n Java field: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>field</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>综上所述，Hessian2序列化的核心的几个类是：Hessian2Output、SerializerFactory(Hessian2SerializerFactory) 、JavaSerializer和FieldSerializer。</p><p>整体思路是：</p><ul><li><code>Hessian2Output#writeObject(Object)</code>：对象 序列化的入口</li><li><code>SerializerFactory#getSerializer(Class)</code>：根据对象类型，找到对应类型的Serializer完成对象序列化，无对应类型的交给JavaSerializer</li><li><code>JavaSerializer#getFieldSerializer(Class)</code>：完成对象类型信息的序列化，然后依次序列化各个字段，为各字段找到对应类型的FieldSerializer子类完成字段序列化，无对应类型的字段交给FieldSerializer。</li><li><code>FieldSerializer#serialize(AbstractHessianOutput, Object, Field)</code>：FieldSerializer会把字段值再当做一个对象，再走一遍整个对象序列化过程。</li></ul><p>这个设计想法是蛮好的，<strong>简单对象直接有对应类序列化，没有对应序列化方法的把对象的序列化拆解成各个字段的序列化。在理想的情况下，所有对象都可以通过不断的拆解，形成简单的对象，然后有相应的Serializer或FieldSerializer完成序列化</strong>。就好像像复杂问题拆解成数个简单问题，也有点像庖丁解牛的感觉。</p><h3 id=36-序列化调用栈 class=heading-element><span>3.6 序列化调用栈</span>
<a href=#36-%e5%ba%8f%e5%88%97%e5%8c%96%e8%b0%83%e7%94%a8%e6%a0%88 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>了解dubbo在hessian2序列化方式时的逻辑之后，再来看本文开头的异常。上述大段文字内容繁多，很难串联起来，我们根据hessian2的序列化逻辑，整理整个序列化过程的调用栈，当然也可以直接打断点看</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ExchangeCodec</span><span class=err>#</span><span class=n>encode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>-&gt;</span><span class=n>ExchangeCodec</span><span class=err>#</span><span class=n>encodeResponseData</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-&gt;</span><span class=n>DubboCodec</span><span class=err>#</span><span class=n>encodeResponseData</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-&gt;</span><span class=n>Hessian2ObjectOutput</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// DemoDTO类型开始序列化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>-&gt;</span><span class=n>Hessian2Output</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>-&gt;</span><span class=n>SerializerFactory</span><span class=err>#</span><span class=n>getSerializer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>-&gt;</span><span class=n>JavaSerializer</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=o>-&gt;</span><span class=n>JavaSerializer</span><span class=err>#</span><span class=n>writeInstance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>-&gt;</span><span class=n>FieldSerializer</span><span class=err>#</span><span class=n>serialize</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=c1>// Instant类型开始序列化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=o>-&gt;</span><span class=n>Hessian2Output</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>-&gt;</span><span class=n>SerializerFactory</span><span class=err>#</span><span class=n>getSerializer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=o>-&gt;</span><span class=n>JavaSerializer</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Ser类型开始序列化(Instant的writeReplace方法产生的替代对象)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>-&gt;</span><span class=n>Hessian2Output</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>-&gt;</span><span class=n>SerializerFactory</span><span class=err>#</span><span class=n>getSerializer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>-&gt;</span><span class=n>JavaSerializer</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                              </span><span class=o>-&gt;</span><span class=n>JavaSerializer</span><span class=err>#</span><span class=n>writeInstance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>-&gt;</span><span class=n>FieldSerializer</span><span class=err>#</span><span class=n>serialize</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=c1>// Instant类型开始序列化(Ser类中的object字段)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=o>-&gt;</span><span class=n>Hessian2Output</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>-&gt;</span><span class=n>SerializerFactory</span><span class=err>#</span><span class=n>getSerializer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                      </span><span class=o>-&gt;</span><span class=n>JavaSerializer</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=c1>// Ser(Instant的writeReplace方法产生的替代类)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=o>-&gt;</span><span class=n>Hessian2Output</span><span class=err>#</span><span class=n>writeObject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                          </span><span class=o>-&gt;</span><span class=w> </span><span class=p>......</span></span></span></code></pre></td></tr></table></div></div><p>通过调用栈，是不是一眼就发现问题所在了？这个调用栈倒序来看，可以发现正好开头是异常栈的顺序。</p><h2 id=4-结论 class=heading-element><span>4 结论</span>
<a href=#4-%e7%bb%93%e8%ae%ba class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>在Dubbo反序列化的过程中，产生的栈溢出的原因是：</p><p><strong>Dubbo(v2.5.3)没有相应的Serializer或FieldSerializer能处理Instant数据类型，并且Instant正好有writeReplace方法，返回的替代类中的object字段又包含Instant本身。导致需要序列化的对象在Instant、Ser之间反复横跳，不断调用序列化方法逻辑，最终方法栈满，导致栈溢出错误。</strong></p><p>结合网上信息，可以发现不只是Instant类，在JDK8新增的时间API，如LocalDateTime、Period等，都会和Instant有一样的问题，也是一样的原因。</p><h2 id=5-解决方案 class=heading-element><span>5 解决方案</span>
<a href=#5-%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>知道了问题的原因之后，就可以对症下药了。本人水平有限，暂时想到以下几种方案：</p><h3 id=51-使用date类型 class=heading-element><span>5.1 使用Date类型</span>
<a href=#51-%e4%bd%bf%e7%94%a8date%e7%b1%bb%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>首先最简单的方式，就是不使用JDK8中引入的时间API，改为使用Date。</p><p>这种方式没有直接解决问题，而是有些逃避问题了。</p><h3 id=51-writereplace--readresolve-方法 class=heading-element><span>5.1 writeReplace / readResolve 方法</span>
<a href=#51-writereplace--readresolve-%e6%96%b9%e6%b3%95 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>修改Instant的writeReplace方法可能不是很方便，我们可以为DemoDTO添加writeReplace方法。总体思路的话就是：provider把Instant拆解成支持的数据类型，到了consumer再转化成Instant。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DemoDTO</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>311647434535770294L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>consumer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Instant</span><span class=w> </span><span class=n>instant</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 序列化时JavaSerializer会调用此方法，然后序列化替代类对象repl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DemoDTOHandle</span><span class=w> </span><span class=nf>writeReplace</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;call writeReplace&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DemoDTOHandle</span><span class=w> </span><span class=n>repl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DemoDTOHandle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>repl</span><span class=p>.</span><span class=na>setConsumer</span><span class=p>(</span><span class=n>consumer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>instant</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>repl</span><span class=p>.</span><span class=na>setSeconds</span><span class=p>(</span><span class=n>instant</span><span class=p>.</span><span class=na>getEpochSecond</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>repl</span><span class=p>.</span><span class=na>setNanos</span><span class=p>(</span><span class=n>instant</span><span class=p>.</span><span class=na>getNano</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>repl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// getter,setter略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>DemoDTOHandle中Instant拆成seconds、nanos字段存储，然后会代替DemoDTO进行序列化传输。代码如下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DemoDTOHandle</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HessianHandle</span><span class=p>,</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>8532997896892606136L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>consumer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>seconds</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>nanos</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 反序列化时，JavaDeserializer会调用此方法，重新组装实际的类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DemoDTO</span><span class=w> </span><span class=nf>readResolve</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;call readResolve&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DemoDTO</span><span class=w> </span><span class=n>dto</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DemoDTO</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dto</span><span class=p>.</span><span class=na>setConsumer</span><span class=p>(</span><span class=n>consumer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dto</span><span class=p>.</span><span class=na>setInstant</span><span class=p>(</span><span class=n>Instant</span><span class=p>.</span><span class=na>ofEpochSecond</span><span class=p>(</span><span class=n>seconds</span><span class=p>,</span><span class=w> </span><span class=n>nanos</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>dto</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// getter,setter略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>DemoDTOHandle为什么要实现HessianHandle接口呢？答案在<code>SerializerFactory#getObjectDeserializer(String, Class)</code>中，如果不是HessianHandle实现类的话，是得不到DemoDTOHandle相关的Deserializer，只有DemoDTO相关的Deserializer，那么就无法使用DemoDTOHandle中的readResolve方法转换回对象了。</p><p><img loading=lazy src=https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220504103337575.png alt=image-20220504103337575 srcset="https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220504103337575.png?size=small, https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220504103337575.png?size=medium 1.5x, https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220504103337575.png?size=large 2x" data-title=image-20220504103337575 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></p><h3 id=52-修改序列化方式 class=heading-element><span>5.2 修改序列化方式</span>
<a href=#52-%e4%bf%ae%e6%94%b9%e5%ba%8f%e5%88%97%e5%8c%96%e6%96%b9%e5%bc%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>之前提到，使用的是dubbo协议、hessian2序列化方式。事实上dubbo协议同样可以使用其他多种序列化方式。下面列举的序列化方式，都可以支持JDK8时间API的序列化处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dubbo:protocol</span> <span class=na>serialization=</span><span class=s>&#34;java&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;dubbo:protocol</span> <span class=na>serialization=</span><span class=s>&#34;compactedjava&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;dubbo:protocol</span> <span class=na>serialization=</span><span class=s>&#34;nativejava&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;dubbo:protocol</span> <span class=na>serialization=</span><span class=s>&#34;json&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;dubbo:protocol</span> <span class=na>serialization=</span><span class=s>&#34;fastjson&#34;</span><span class=nt>/&gt;</span></span></span></code></pre></td></tr></table></div></div><p>当然如果升级了Dubbo版本的话，会支持更多的序列化方式。</p><h3 id=53-升级dubbo版本 class=heading-element><span>5.3 升级Dubbo版本（√）</span>
<a href=#53-%e5%8d%87%e7%ba%a7dubbo%e7%89%88%e6%9c%ac class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>当然，使用的Dubbo版本是2.5.3，实在是太老了。搜索maven仓库，看到2.5.3版本更新时间是2012年，十年前。</p><p><img loading=lazy src=https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220503122841533.png alt=image-20220503122841533 srcset="https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220503122841533.png?size=small, https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220503122841533.png?size=medium 1.5x, https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220503122841533.png?size=large 2x" data-title=image-20220503122841533 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></p><p><strong>可以选择升级到2.6.x版本</strong>。会发现2.6.x版本在序列化方面也做了一些优化。新版本不仅包含了新功能，扩展性也有所提升。但是需要注意，如果是升级2.6.6+版本，需要关注netty版本的变化。</p><h4 id=26x-支持jdk8时间api class=heading-element><span>2.6.x 支持JDK8时间API</span>
<a href=#26x-%e6%94%af%e6%8c%81jdk8%e6%97%b6%e9%97%b4api class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>在2.6.x版本中，在SerializerFactory 中增加了对JDK8时间API的处理，加入了Java8TimeSerializer以及一系列的HessianHandle。<strong>意味着2.6.x版本Dubbo将不再有本文开头遇到的问题。</strong></p><p><img loading=lazy src=https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220503123444697.png alt=image-20220503123444697 srcset="https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220503123444697.png?size=small, https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220503123444697.png?size=medium 1.5x, https://dingyufan-github-io.oss-cn-hangzhou.aliyuncs.com/image-20220503123444697.png?size=large 2x" data-title=image-20220503123444697 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></p><h4 id=26x-支持扩展serializerfactory class=heading-element><span>2.6.x 支持扩展SerializerFactory</span>
<a href=#26x-%e6%94%af%e6%8c%81%e6%89%a9%e5%b1%95serializerfactory class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>同时SerializerFactory 也提供了一定的扩展性，支持添加你想要的SerializerFactory。如果还有目标序列化方式无法处理的类型，可以自定义SerializerFactory、Serializer，只要将自定义SerializerFactory添加到当前序列化方式的SerializerFactory 中，就可以轻松扩展。<strong>在2.5.x上是不支持这种扩展的</strong>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// SerializerFactory.java  2.6.x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SerializerFactory</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractSerializerFactory</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>ArrayList</span><span class=w> </span><span class=n>_factories</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addFactory</span><span class=p>(</span><span class=n>AbstractSerializerFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>_factories</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>factory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Serializer</span><span class=w> </span><span class=nf>getSerializer</span><span class=p>(</span><span class=n>Class</span><span class=w> </span><span class=n>cl</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>HessianProtocolException</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Serializer</span><span class=w> </span><span class=n>serializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Serializer</span><span class=p>)</span><span class=w> </span><span class=n>_staticSerializerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serializer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>serializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_cachedSerializerMap</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>_cachedSerializerMap</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Serializer</span><span class=p>)</span><span class=w> </span><span class=n>_cachedSerializerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serializer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>serializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 遍历扩展的SerializerFactory。尝试由扩展的SerializerFactory提供Serializer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 2.5.3没有这个功能</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>serializer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>_factories</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_factories</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>  </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AbstractSerializerFactory</span><span class=w> </span><span class=n>factory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AbstractSerializerFactory</span><span class=p>)</span><span class=w> </span><span class=n>_factories</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>.</span><span class=na>getSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serializer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>JavaSerializer</span><span class=p>.</span><span class=na>getWriteReplace</span><span class=p>(</span><span class=n>cl</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JavaSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>_loader</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>HessianRemoteObject</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RemoteSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//    else if (BurlapRemoteObject.class.isAssignableFrom(cl))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//      serializer = new RemoteSerializer();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_mapSerializer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_mapSerializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MapSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_mapSerializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Collection</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_collectionSerializer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_collectionSerializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CollectionSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_collectionSerializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cl</span><span class=p>.</span><span class=na>isArray</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArraySerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThrowableSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>getClassLoader</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InputStreamSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Iterator</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IteratorSerializer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Enumeration</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EnumerationSerializer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Calendar</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CalendarSerializer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Locale</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LocaleSerializer</span><span class=p>.</span><span class=na>create</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Enum</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>cl</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EnumSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serializer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getDefaultSerializer</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_cachedSerializerMap</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_cachedSerializerMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>(</span><span class=n>8</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>_cachedSerializerMap</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_cachedSerializerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>serializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>serializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=54-spi扩展serialization class=heading-element><span>5.4 SPI扩展Serialization</span>
<a href=#54-spi%e6%89%a9%e5%b1%95serialization class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>这个方法理论上是完全可行的，但是有些过于大动干戈了。总体思路是：借助Dubbo的SPI机制，对Serialization进行扩展，基于hessian2的SerializerFactory ，对Serializer、Deserializer进行扩展。</p><h2 id=6-写在最后 class=heading-element><span>6 写在最后</span>
<a href=#6-%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>最开始计划用一两天的时间写完这篇博客，但是过程中又不断的遇到问题、解决问题，最终花了整个五一假期才完成。通过这个问题，算是对Dubbo框架的序列化这块有了一些了解了。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-07-28 16:32:25">更新于 2023-07-28&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/dubbo/ class=post-tag title="标签 - Dubbo">Dubbo</a><a href=/tags/java/ class=post-tag title="标签 - Java">Java</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/githubpages-hugo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/ class=post-nav-item rel=prev title="GitHub Pages + Hugo搭建个人博客"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>GitHub Pages + Hugo搭建个人博客</a><a href=/posts/%E6%B5%85%E5%B0%9D%E6%A0%91%E8%8E%93%E6%B4%BE4bubuntu22.04%E5%AE%89%E8%A3%85clash%E4%BD%9C%E4%B8%BA%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/ class=post-nav-item rel=next title=浅尝树莓派4B(Ubuntu22.04)安装Clash作为代理服务器>浅尝树莓派4B(Ubuntu22.04)安装Clash作为代理服务器<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=dingyufan/dingyufan.github.io data-repo-id=R_kgDOKAsu4A data-category=Announcements data-category-id=DIC_kwDOKAsu4M4CYL_F data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-lang=zh-CN crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.138.0"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.15"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2022 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=preload href=/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:1024},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light",origin:"https://giscus.app"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},version:"v0.3.15"}</script><script src=/js/theme.min.js defer></script></body></html>